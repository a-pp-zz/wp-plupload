(function(d){var a=[];function f(h,k,g,j){var i=null;switch(k){case plupload.FAILED:i=pluploadConfig.upload_failed;break;case plupload.FILE_EXTENSION_ERROR:i=pluploadConfig.invalid_filetype;break;case plupload.FILE_SIZE_ERROR:i=pluploadConfig.file_exceeds_size_limit.replace("%s",h.name);break;case plupload.IMAGE_FORMAT_ERROR:i=pluploadConfig.not_an_image;break;case plupload.IMAGE_MEMORY_ERROR:i=pluploadConfig.image_memory_exceeded;break;case plupload.IMAGE_DIMENSIONS_ERROR:i=pluploadConfig.image_dimensions_exceeded;break;case plupload.GENERIC_ERROR:i=pluploadConfig.upload_failed;break;case plupload.IO_ERROR:i=pluploadConfig.io_error;break;case plupload.HTTP_ERROR:i=pluploadConfig.http_error;break;case plupload.SECURITY_ERROR:i=pluploadConfig.security_error;break;default:i=pluploadConfig.default_error}return i}var b=function(j,h,k){var i="#media-item-o_"+h.id;j="<strong>«"+h.name+"»</strong><br />"+j;var g='<div class="plupload-error"><a class="dismiss" href="#">Закрыть</a>'+j+"</div>";if(d(i).length>0){d(i).html(g)}else{d(k).append('<div class="media-item child-of-0" id="media-item-o_'+h.id+'">'+g+"</div>")}};var e=function(i,o,g,k){var h="#media-item-o_"+i.id;var j="<strong>"+i.name+"</strong>";var n=false;var m=false;if(o){j+="<br />"+o}switch(k){case"new":className="plupload-new";n=false;m=true;j='<div class="filename original">'+i.name+"</div>";break;case"error":className="plupload-error";n=true;m=false;break;case"success":className="plupload-success";n=true;m=false;break;case"finish":className="plupload-finish";n=false;m=false;j="Все файлы успешно загружены!";break}var l='<div class="plupload-status '+className+'">';if(n){l+='<a class="dismiss" href="#">Закрыть</a>'}if(m){l+='<div class="progress"><div class="percent">0%</div><div class="bar" style="width: 0px;"></div></div>'}l+=j+"</div>";if(d(h).length>0){d(h).html(l)}else{d(g).append('<div class="media-item child-of-0" id="media-item-o_'+i.id+'">'+l+"</div>")}};var c=function(h){var l=d(h).data();var k={action:"plupload",_wpnonce:l.nonce};var j={newname:l.name,types:l.types,dir:l.dir,ow:l.ow};var o=d(h).find(".plupload-pickfiles");var p=d(h).find(".plupload-max-file-size");var q=d(h).find(".plupload-allowed-formats");var i=d(h).find(".plupload-filelist");var g={};if(l.receiver){var n=d(l.receiver);if(d(n).length>0){g.tag=n.prop("tagName").toLowerCase();g.obj=n}else{g=null}}var m=new plupload.Uploader({runtimes:"html5,html4",browse_button:d(o).attr("id"),container:d(h).attr("id"),max_file_size:l.maxsize,url:ajaxurl+"?"+d.param(k),file_data_name:l.filefield,multi_selection:l.multi?true:false,multipart_params:j,filters:[{title:"Разрешенные типы",extensions:l.types}]});m.bind("Init",function(r,s){d(p).html(l.maxsize);d(q).html(l.types);if(l.multi){d(h).find(".plupload-features").append("<div>Можно загрузить несколько файлов одновременно</div>")}});m.bind("FilesAdded",function(r,s){d(h).removeClass("is-uploaded");d(i).html("");if(g){if(g.tag=="input"||g.tag=="textarea"){g.obj.val("")}else{g.obj.html("")}}d.each(s,function(u,t){e(t,null,d(i),"new")});r.refresh();m.start()});m.bind("UploadProgress",function(r,s){var t="#media-item-o_"+s.id;d(t).find(".plupload-remove-file").hide();d(t).find(".progress").show();d(t).find(".progress .percent").html(s.percent+"%");d(t).find(".progress .bar").css("width",s.percent*2)});m.bind("Error",function(r,t){d(h).removeClass("is-uploaded");var s=f(t.file,t.code,t.message,r);e(t.file,s,d(i),"error");r.refresh();if(g){if(g.tag=="input"||g.tag=="textarea"){g.obj.val("")}else{g.obj.html("")}}});d(".plupload-filelist").on("click",".media-item a.dismiss",function(){d(this).parent().parent().remove();return false});m.bind("UploadComplete",function(r,u){d(h).addClass("is-uploaded");if(g){if(g.tag=="input"||g.tag=="textarea"){if(a.length===0){g.obj.val("")}else{var t=JSON.stringify(a);g.obj.val(t)}}else{if(l.type=="image"&&a.length===1){var s='<img src="/'+response.filename+'" />';g.obj.html(s)}}}a=[]});m.bind("FileUploaded",function(r,t,u){var s=d.parseJSON(u.response);if(s.status===201){a.push(s.filename);e(t,"Файл успешно загружен!",d(i),"success")}else{e(t,s.message,d(i),"error")}});m.init()};d(function(){d(".wp-plupload-container").each(function(){c(d(this))})})})(jQuery);